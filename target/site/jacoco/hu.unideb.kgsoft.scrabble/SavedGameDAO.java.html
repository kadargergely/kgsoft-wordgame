<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>SavedGameDAO.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">kgsoft-scrabble</a> &gt; <a href="index.source.html" class="el_package">hu.unideb.kgsoft.scrabble</a> &gt; <span class="el_source">SavedGameDAO.java</span></div><h1>SavedGameDAO.java</h1><pre class="source lang-java linenums">package hu.unideb.kgsoft.scrabble;

import hu.unideb.kgsoft.scrabble.model.SavedGame;
import hu.unideb.kgsoft.scrabble.utils.Utils;

import java.io.IOException;
import java.math.BigDecimal;
import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

import oracle.jdbc.OracleConnection;
import oracle.jdbc.OraclePreparedStatement;
import oracle.jdbc.OracleResultSet;

<span class="fc" id="L18">public class SavedGameDAO {</span>

    private Field[][] getFieldsBySavedGameId(int savedGameId)
            throws IOException {
<span class="nc" id="L22">        Field[][] fields = new Field[Gameboard.BOARD_SIZE][Gameboard.BOARD_SIZE];</span>

<span class="nc" id="L24">        try (Connection connection = ConnectionFactory.getConnection()) {</span>
<span class="nc" id="L25">            Statement st = connection.createStatement();</span>
<span class="nc" id="L26">            ResultSet rset = st.executeQuery(String.format(</span>
<span class="nc" id="L27">                    &quot;select row_index, col_index, status, multiplier, tile_code, joker_tile_code &quot;</span>
                            + &quot;from fields &quot; + &quot;where saved_game_id=%s&quot;,
<span class="nc" id="L29">                    Integer.toString(savedGameId)));</span>

<span class="nc bnc" id="L31" title="All 2 branches missed.">            while (rset.next()) {</span>
<span class="nc" id="L32">                fields[rset.getInt(1)][rset.getInt(2)] = new Field(</span>
<span class="nc" id="L33">                        Field.Status.valueOf(rset.getString(3)),</span>
<span class="nc" id="L34">                        Field.Multiplier.valueOf(rset.getString(4)),</span>
<span class="nc" id="L35">                        rset.getInt(5), rset.getInt(6));</span>
            }
<span class="nc bnc" id="L37" title="All 8 branches missed.">        } catch (SQLException e) {</span>
            // TODO log - ez baj, ilyen nem kene legyen
<span class="nc" id="L39">            System.out.println(e.getMessage());</span>
        }

<span class="nc" id="L42">        return fields;</span>
    }
    
    private void insertFields(int savedGameId, Field[][] fields) throws IOException {
<span class="nc" id="L46">        try (Connection connection = ConnectionFactory.getConnection()) {</span>
<span class="nc" id="L47">            Statement st = connection.createStatement();</span>
<span class="nc bnc" id="L48" title="All 2 branches missed.">            for (int i = 0; i &lt; fields.length; i++) {</span>
<span class="nc bnc" id="L49" title="All 2 branches missed.">                for (int j = 0; j &lt; fields[i].length; j++) {</span>
<span class="nc" id="L50">                    st.executeUpdate(</span>
<span class="nc" id="L51">                            String.format(&quot;insert into fields values (%s, %s, %s, '%s', '%s', %s, %s)&quot;, </span>
<span class="nc" id="L52">                                    Integer.toString(savedGameId), Integer.toString(i), Integer.toString(j),</span>
<span class="nc" id="L53">                                    fields[i][j].getStatus(), fields[i][j].getMultiplier(),</span>
<span class="nc" id="L54">                                    Integer.toString(fields[i][j].getTileCode()),</span>
<span class="nc" id="L55">                                    Integer.toString(fields[i][j].getJokerTileCode())));</span>
                }
            }
<span class="nc bnc" id="L58" title="All 8 branches missed.">        } catch (SQLException e) {</span>
<span class="nc" id="L59">            e.printStackTrace();</span>
        }
<span class="nc" id="L61">    }</span>

    public SavedGame getSavedGameByUserName(String username)
            throws IOException, NoSavedGameException {
<span class="nc" id="L65">        SavedGame savedGame = null;</span>

<span class="nc" id="L67">        try (Connection connection = ConnectionFactory.getConnection()) {</span>
<span class="nc" id="L68">            Statement st = connection.createStatement();</span>
<span class="nc" id="L69">            ResultSet rset = st.executeQuery(String.format(</span>
<span class="nc" id="L70">                    &quot;select * from saved_games where username='%s'&quot;, username));</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">            if (rset.next()) {</span>
<span class="nc" id="L72">                Field[][] fields = getFieldsBySavedGameId(rset.getInt(1));</span>
<span class="nc" id="L73">                BigDecimal[] playerTray = (BigDecimal[]) (((OracleResultSet) rset)</span>
<span class="nc" id="L74">                        .getARRAY(3).getArray());</span>
<span class="nc" id="L75">                BigDecimal[] computerTray = (BigDecimal[]) (((OracleResultSet) rset)</span>
<span class="nc" id="L76">                        .getARRAY(4).getArray());                </span>
<span class="nc" id="L77">                String[] lastWords = (String[]) rset.getArray(9).getArray();                </span>
<span class="nc" id="L78">                BigDecimal[] bagRemaining = (BigDecimal[]) (((OracleResultSet) rset)</span>
<span class="nc" id="L79">                        .getARRAY(11).getArray());</span>
<span class="nc" id="L80">                savedGame = new SavedGame(fields, Utils.toIntArray(playerTray),</span>
<span class="nc" id="L81">                        Utils.toIntArray(computerTray), rset.getInt(5),</span>
<span class="nc" id="L82">                        rset.getInt(6), rset.getInt(7), rset.getInt(8),</span>
<span class="nc" id="L83">                        lastWords, rset.getInt(10),</span>
<span class="nc" id="L84">                        Utils.toIntArray(bagRemaining));</span>
<span class="nc" id="L85">            } else {</span>
<span class="nc" id="L86">                throw new NoSavedGameException();</span>
            }
<span class="nc bnc" id="L88" title="All 8 branches missed.">        } catch (SQLException e) {</span>
            // TODO log - ez baj, ilyen nem kene legyen
<span class="nc" id="L90">            System.out.println(e.getMessage());</span>
        }

<span class="nc" id="L93">        return savedGame;</span>
    }

    public void newSavedGame(String username, SavedGame savedGame)
            throws IOException {
<span class="nc" id="L98">        try (Connection connection = ConnectionFactory.getConnection()) {            </span>
<span class="nc" id="L99">            Statement st = connection.createStatement();</span>
<span class="nc" id="L100">            ResultSet rset = st</span>
<span class="nc" id="L101">                    .executeQuery(String.format(&quot;select count(username) &quot;</span>
<span class="nc" id="L102">                            + &quot;from saved_games where username='%s'&quot;, username));</span>
<span class="nc" id="L103">            Integer[] playerTrayInteger = Utils.toIntegerArray(savedGame</span>
<span class="nc" id="L104">                    .getPlayerTray());</span>
<span class="nc" id="L105">            Integer[] computerTrayInteger = Utils.toIntegerArray(savedGame</span>
<span class="nc" id="L106">                    .getComputerTray());</span>
<span class="nc" id="L107">            Integer[] bagRemainingInteger = Utils.toIntegerArray(savedGame</span>
<span class="nc" id="L108">                    .getBagRemaining());</span>
<span class="nc bnc" id="L109" title="All 4 branches missed.">            if (rset.next() &amp;&amp; rset.getInt(1) == 1) {</span>
//                PreparedStatement pst = connection
//                        .prepareStatement(&quot;update saved_games &quot;
//                                + &quot;set player_tray=?,&quot; + &quot;computer_tray=?,&quot;
//                                + &quot;tile_in_hand=?,&quot; + &quot;players_turn=?,&quot;
//                                + &quot;player_score=?,&quot;
//                                + &quot;computer_score=?,&quot; + &quot;last_words=?,&quot;
//                                + &quot;last_words_points=?,&quot;
//                                + &quot;bag_remaining=? &quot; + &quot;where username='&quot;
//                                + username + &quot;'&quot;);
                
<span class="nc" id="L120">                PreparedStatement pst = connection.prepareStatement(</span>
<span class="nc" id="L121">                        &quot;update saved_games &quot;</span>
                        + &quot;set player_tray=?, computer_tray=?, tile_in_hand=?, players_turn=?, player_score=?, &quot;
                        + &quot;computer_score=?, last_words=?, last_words_points=?, bag_remaining=? where username='&quot; 
<span class="nc" id="L124">                        + username + &quot;'&quot;);</span>

<span class="nc" id="L126">                ((OraclePreparedStatement) pst).setARRAY(1,</span>
<span class="nc" id="L127">                        ((OracleConnection) connection).createARRAY(&quot;T_TRAY&quot;,</span>
<span class="nc" id="L128">                                playerTrayInteger));</span>
<span class="nc" id="L129">                ((OraclePreparedStatement) pst).setARRAY(2,</span>
<span class="nc" id="L130">                        ((OracleConnection) connection).createARRAY(&quot;T_TRAY&quot;,</span>
<span class="nc" id="L131">                                computerTrayInteger));</span>
<span class="nc" id="L132">                pst.setInt(3, savedGame.getTileInHand());</span>
<span class="nc bnc" id="L133" title="All 2 branches missed.">                pst.setInt(4, (savedGame.isPlayersTurn() ? 1 : 0));</span>
<span class="nc" id="L134">                pst.setInt(5, savedGame.getPlayerScore());</span>
<span class="nc" id="L135">                pst.setInt(6, savedGame.getComputerScore());</span>
<span class="nc" id="L136">                ((OraclePreparedStatement) pst).setARRAY(7,</span>
<span class="nc" id="L137">                        ((OracleConnection) connection).createARRAY(&quot;T_WORDS&quot;,</span>
<span class="nc" id="L138">                                savedGame.getLastWords()));</span>
<span class="nc" id="L139">                pst.setInt(8, savedGame.getLastWordsPoints());</span>
<span class="nc" id="L140">                ((OraclePreparedStatement) pst).setARRAY(9,</span>
<span class="nc" id="L141">                        ((OracleConnection) connection).createARRAY(&quot;T_BAG&quot;,</span>
<span class="nc" id="L142">                                bagRemainingInteger));</span>
<span class="nc" id="L143">                System.out.println(&quot;meg elek!&quot;);                </span>
<span class="nc" id="L144">                pst.executeUpdate();</span>
<span class="nc" id="L145">                System.out.println(&quot;mar nem&quot;);                </span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">            } else if (rset.getInt(1) == 0) {</span>
<span class="nc" id="L147">                PreparedStatement pst = connection</span>
<span class="nc" id="L148">                        .prepareStatement(&quot;insert into saved_games values(&quot;</span>
<span class="nc" id="L149">                                + &quot;null, '&quot; + username + &quot;',&quot;</span>
<span class="nc" id="L150">                                + &quot;?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;);</span>

<span class="nc" id="L152">                ((OraclePreparedStatement) pst).setARRAY(1,</span>
<span class="nc" id="L153">                        ((OracleConnection) connection).createARRAY(&quot;T_TRAY&quot;,</span>
<span class="nc" id="L154">                                playerTrayInteger));</span>
<span class="nc" id="L155">                ((OraclePreparedStatement) pst).setARRAY(2,</span>
<span class="nc" id="L156">                        ((OracleConnection) connection).createARRAY(&quot;T_TRAY&quot;,</span>
<span class="nc" id="L157">                                computerTrayInteger));</span>
<span class="nc" id="L158">                pst.setInt(3, savedGame.getTileInHand());</span>
<span class="nc bnc" id="L159" title="All 2 branches missed.">                pst.setInt(4, (savedGame.isPlayersTurn() ? 1 : 0));</span>
<span class="nc" id="L160">                pst.setInt(5, savedGame.getPlayerScore());</span>
<span class="nc" id="L161">                pst.setInt(6, savedGame.getComputerScore());</span>
<span class="nc" id="L162">                ((OraclePreparedStatement) pst).setARRAY(7,</span>
<span class="nc" id="L163">                        ((OracleConnection) connection).createARRAY(&quot;T_WORDS&quot;,</span>
<span class="nc" id="L164">                                savedGame.getLastWords()));</span>
<span class="nc" id="L165">                pst.setInt(8, savedGame.getLastWordsPoints());</span>
<span class="nc" id="L166">                ((OraclePreparedStatement) pst).setARRAY(9,</span>
<span class="nc" id="L167">                        ((OracleConnection) connection).createARRAY(&quot;T_BAG&quot;,</span>
<span class="nc" id="L168">                                bagRemainingInteger));</span>

<span class="nc" id="L170">                pst.executeUpdate();</span>
            }
            
<span class="nc" id="L173">            st.executeUpdate(String.format(</span>
<span class="nc" id="L174">                    &quot;update saved_games set last_words=t_words(%s) where username='%s'&quot;, </span>
<span class="nc" id="L175">                    Utils.stringArrayToString(savedGame.getLastWords()), username));</span>
            
<span class="nc" id="L177">            System.out.println(&quot;id select&quot;);</span>
<span class="nc" id="L178">            rset = st.executeQuery(&quot;select saved_game_id from saved_games where username='&quot; + username + &quot;'&quot;);</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (rset.next()) {</span>
<span class="nc" id="L180">                int id = rset.getInt(1);</span>
<span class="nc" id="L181">                System.out.println(&quot;delete&quot;);</span>
<span class="nc" id="L182">                st.executeUpdate(&quot;delete from fields where saved_game_id=&quot; + id);</span>
<span class="nc" id="L183">                System.out.println(&quot;insert&quot;);</span>
<span class="nc" id="L184">                insertFields(id, savedGame.getFields());</span>
            }
<span class="nc bnc" id="L186" title="All 8 branches missed.">        } catch (SQLException e) {</span>
            // TODO log - ez baj, ilyen nem kene legyen
<span class="nc" id="L188">            System.out.println(e.getMessage());</span>
<span class="nc" id="L189">            e.printStackTrace();</span>
        }
<span class="nc" id="L191">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.4.201502262128</span></div></body></html>